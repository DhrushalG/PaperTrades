@model Wallet

<link rel="stylesheet" href="~/css/style.css" type="text/css">
<meta http-equiv="refresh" content="60;" />
<div class="container">
    @{
        foreach (var c in @ViewBag.AllCryptos)
        {
            if (c.id == @Model.IsTracking)
            {
                <div class="mt-3 mb-2 d-flex justify-content-around">
                    <div class="card bg-dark viewonetable" style="max-width: 40%;">
                        <div class="card-header font-weight-italics">
                            <h3 class="mycoin" id="mycoin">My @c.name</h3>
                        </div>
                        <div class="card-body">
                            <table class="table table-dark table-sm">
                                <thead>
                                    <th>Buy-in Price</th>
                                    <th>Buy-in Value</th>
                                    <th>Quantity</th>
                                </thead>
                                <tbody>
                                    <tr>
                                        @{
                                            double currprice = @c.current_price;
                                            double currquant = @Model.Quantity;
                                            double differenceval = @c.current_price - @Model.AvgBuyingPrice;
                                            double avg = @Model.AvgBuyingPrice * @Model.Quantity;
                                            double currval = currprice * currquant;
                                            double gainlossdec = (differenceval * currquant) / avg;
                                            double gainlossprct = gainlossdec * 100;
                                            
                                            double currret = (currprice * currquant) - avg;
                                        }

                                        @{
                                            if(@Model.AvgBuyingPrice < 1 ){
                                                <td>$@Model.AvgBuyingPrice.ToString("#,##0.##########")</td>
                                            } else {
                                                <td>$@Model.AvgBuyingPrice.ToString("#,##0.####")</td>
                                            }
                                        }

                                        <td>
                                            $@avg.ToString("#,##0.###")
                                        </td>

                                        <td>
                                            @Model.Quantity.ToString("#,##0.###")
                                        </td>

                                        @* @{
                                            if(currret < 0){
                                                double negcurrret = Math.Abs(currret);
                                                <td class="text-danger">-$@negcurrret.ToString("#,##0.####") (+@gainlossprct.ToString("#,##0.###")%)</td>
                                            } else {
                                                <td class="text-success">+$@currret.ToString("#,##0.####") (@gainlossprct.ToString("#,##0.###")%)</td>
                                            }
                                        } *@
                                        @* @{
                                            if(gainlossprct >= 0)
                                            {
                                                <td class="text-sm">$@currval.ToString("#,##0.###")</td>
                                            } else {
                                                <td class="text-sm">$@currval.ToString("#,##0.###")</td>
                                            }
                                        } *@
                                    </tr>

                                    <tr>
                                        <th>Current Price</th>
                                        <th>Current Value</th>
                                        <th>Current Return</th>
                                    </tr>

                                    <tr>
                                        @{
                                            if( currprice < 1){
                                                <td>$@c.current_price.ToString("#,##0.##########")</td>
                                            }else{
                                                <td>$@c.current_price.ToString("#,##0.####")</td>
                                            }

                                            
                                            if(gainlossprct >= 0)
                                            {
                                                <td class="text-sm">$@currval.ToString("#,##0.###")</td>
                                            } else {
                                                <td class="text-sm">$@currval.ToString("#,##0.###")</td>
                                            }

                                            if(currret < 0){
                                                double negcurrret = Math.Abs(currret);
                                                <td class="text-danger">-$@negcurrret.ToString("#,##0.####") (@gainlossprct.ToString("#,##0.###")%)</td>
                                            } else {
                                                <td class="text-success">+$@currret.ToString("#,##0.####") (+@gainlossprct.ToString("#,##0.###")%)</td>
                                            }

                                            @* if(gainlossprct >= 0)
                                            {
                                                <td class="text-success text-sm">$@currval.ToString("#,##0.###") (+@gainlossprct.ToString("#,##0.###")%)</td>
                                            } else {
                                                <td class="text-danger text-sm">$@currval.ToString("#,##0.###") (@gainlossprct.ToString("#,##0.###")%)</td>
                                            } *@
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <table class="table table-striped table-sm table-dark ml-5 mb-5 viewonetable" style="max-width: 50%; height: 250%;">
                        <thead>
                            <th>Price Change (24hr)</th>
                            <th>High / Low (24hr)</th>
                            <th>Circulating / Total Supply</th>
                        </thead>
                        <tbody>
                            <tr class="text-center">
                                @{
                                    if(c.price_change_24h < 1 && c.price_change_24h > -1)
                                    {
                                        if(c.price_change_24h < 0)
                                        {
                                            double percval = @c.price_change_24h;
                                            double chnge = Math.Abs(percval);
                                            <td class="text-danger">-$@chnge.ToString("#,##0.#########") <hr>
                                            @c.price_change_percentage_24h.ToString("#,##0.###")%</td> 
                                        } else {
                                            <td class="text-success">+$@c.price_change_24h.ToString("#,##0.#########") <hr>
                                            @c.price_change_percentage_24h.ToString("#,##0.###")%</td> 
                                        }

                                    } else {
                                        if(c.price_change_24h < 0)
                                        {
                                            double percval = @c.price_change_24h;
                                            double chnge = Math.Abs(percval);
                                            <td class="text-danger">-$@chnge.ToString("#,##0.####") <hr>
                                            @c.price_change_percentage_24h.ToString("#,##0.###")%</td> 
                                        } else {
                                            <td class="text-success">$@c.price_change_24h.ToString("#,##0.####") <hr>
                                            @c.price_change_percentage_24h.ToString("#,##0.###")% </td>
                                        }
                                    }
                                }
                                @{
                                    if(c.high_24h <= 1 || c.low_24h <= 1)
                                    {
                                        <td>$@c.high_24h.ToString("#,##0.#########") <hr> $@c.low_24h.ToString("#,##0.#########")</td>
                                    } else {
                                        <td>$@c.high_24h.ToString("#,##0.##") <hr> $@c.low_24h.ToString("#,##0.##")</td>
                                    }
                                }
                                <td>
                                    @c.circulating_supply.ToString("#,##0.###") <hr>
                                    @{
                                        if (@c.total_supply == null)
                                        {
                                            <Label class="text-danger">Data DNE</Label>
                                        }
                                        else
                                        {
                                            @c.total_supply.ToString("#,##0.###")
                                        }
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                </div>
                <div class="d-flex" style="height: 300px;">
                    
                    <div style="height: 220px; width: 55%; overflow-y: scroll;" class="mr-5 mt-2">
                        
                        <table class="table table-dark table-striped table-sm viewonetable">
                            
                            <thead>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Transaction Statement</th>
                            </thead>
                            @if(@Model.myReceipts.Count >= 1)
                            {
                            @* <div style="height: 225px; width: 100%; overflow-y: scroll;"> *@
                                <tbody>
                                    @{
                                        foreach(Receipt r in @Model.myReceipts)
                                        {
                                        <tr>
                                            @{
                                                string date = @r.CreatedAt.Month + "/" + @r.CreatedAt.Day;
                                            }
                                            <td class="text-white">@date</td>
                                            @if(@r.CreatedAt.Hour > 12)
                                            {
                                                int pmtime = @r.CreatedAt.Hour - 12;
                                                string ptime = pmtime + ":" + @r.CreatedAt.Minute + "pm";
                                                <td class="text-white">@ptime</td>
                                            } else {
                                                if (@r.CreatedAt.Hour == 0)
                                                {
                                                    string time = "12:" + @r.CreatedAt.Minute + "am";
                                                    <td class="text-white">@time</td>
                                                } else {
                                                        string time = @r.CreatedAt.Hour + ":" + @r.CreatedAt.Minute + "am";
                                                        <td class="text-white">@time</td>
                                                }
                                            }
                                            @{
                                                if( @r.Gain == 0 && @r.Loss == 0)
                                                { 
                                                    if( r.TransactionPrice < 1 )
                                                        {
                                                            <td class="text-info text-sm" style="max-width: 70%;">@r.Owner.Name bought @r.Quantity.ToString("#,##0.###") coins of @c.name at $@r.TransactionPrice.ToString("#,##0.######") for a total of $@r.Value.ToString("#,##0.###")</td>
                                                        } else {
                                                            <td class="text-info text-sm" style="max-width: 70%;">@r.Owner.Name bought @r.Quantity.ToString("#,##0.###") coins of @c.name at $@r.TransactionPrice.ToString("#,##0.###") for a total of $@r.Value.ToString("#,##0.###")</td>
                                                        }
                                                } else {
                                                    if ( @r.Gain != 0)
                                                        {
                                                            if( @c.current_price < 1){
                                                                <td class="text-success text-sm" style="max-width: 70%;">@r.Owner.Name sold @r.Quantity.ToString("#,##0.###") coins of @c.name at $@c.current_price.ToString("#,##0.######") for a total of $@r.Value.ToString("#,##0.###") making $@r.Gain.ToString("#,##0.###")</td>
                                                            }else{
                                                                <td class="text-success text-sm" style="max-width: 70%;">@r.Owner.Name sold @r.Quantity.ToString("#,##0.###") coins of @c.name at $@c.current_price.ToString("#,##0.###") for a total of $@r.Value.ToString("#,##0.###") making $@r.Gain.ToString("#,##0.###")</td>
                                                            }
                                                        } 
                                                        else if ( @r.Loss != 0)
                                                        {
                                                            if( @c.current_price < 1){
                                                                <td class="text-danger text-sm" style="max-width: 70%;">@r.Owner.Name sold @r.Quantity.ToString("#,##0.###") coins of @c.name at $@c.current_price.ToString("#,##0.######") for a total of $@r.Value.ToString("#,##0.###") losing $@r.Loss.ToString("#,##0.###")</td>
                                                            }else{
                                                                <td class="text-danger text-sm" style="max-width: 70%;">@r.Owner.Name sold @r.Quantity.ToString("#,##0.###") coins of @c.name at $@c.current_price.ToString("#,##0.###") for a total of $@r.Value.ToString("#,##0.###") losing $@r.Loss.ToString("#,##0.###")</td>
                                                            }
                                                        }
                                                    }
                                                }
                                        </tr>
                                        }
                                    }
                                </tbody>
                            }
                        </table>
                    </div>
                    <div class="ml-2" style="width: 35%;">
                        <div>
                            @* <a class="btn btn-success" data-toggle="collapse" href="#multiCollapseExample1" role="button">Buy more Crypto</a>
                            <button class="btn btn-danger" type="button" data-toggle="collapse" data-target="#multiCollapseExample2">Sell Crypto</button> *@
                            <button class="btn btn-primary" type="button" data-toggle="collapse" data-target=".multi-collapse">Buy/Sell</button>
                        </div>
                        <div class=" my-3">
                            <div class="collapse multi-collapse" style="width: 75%;" id="multiCollapseExample1">
                                <div class="card card-body bg-secondary border-0">
                                    <form action="/buy/@c.id" class="form-group d-flex" method="post">
                                        @* <label for="Quantity">Quantity</label> *@
                                        <input type="number" step=".001" class="form-control" name="Quantity" for="Quantity">
                                        <input type="hidden" value="@Model.UserId" name="UserId" for="UserId">
                                        <input type="hidden" value="@Model.WalletId" name="WalletId" for="WalletId">
                                        <input type="hidden" value="@c.current_price" name="TransactionPrice" for="TransactionPrice">
                                        <input type="hidden" value="@DateTime.Now" for="UpdatedAt" name="UpdatedAt"/>      
                                        <input class="btn btn-success ml-2" type="Submit" value="Buy Crypto">
                                    </form>
                                </div>
                            </div>
                            <div class="collapse multi-collapse" style="width: 75%;" id="multiCollapseExample2">
                                <div class="card card-body bg-secondary border-0">
                                    <form action="/sell/@c.id" class="form-group d-flex" method="post">
                                        @* <label for="Quantity">Quantity</label> *@
                                        <input type="number" step=".001" name="Quantity" class="form-control" for="Quantity">
                                        <input type="hidden" value="@Model.UserId" name="UserId" for="UserId">
                                        <input type="hidden" value="@Model.WalletId" name="WalletId" for="WalletId">
                                        <input type="hidden" value="@c.current_price" name="TransactionPrice" for="TransactionPrice">
                                        <input type="hidden" value="@DateTime.Now" for="UpdatedAt" name="UpdatedAt"/>
                                        <input class="btn btn-danger ml-2" type="Submit" value="Sell Crypto">
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    }
</div>
<script type="text/javascript" lang="Javascript"
    src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript" language="javasacript">
    var idleInterval = setInterval("reloadPage()", 5000); //5s
    function reloadPage() {
        location.reload();
        int refreshcount = 0;
        console.log(Rrefreshcount);
        refreshcount++;
    }
</script>